name: Maven Test Triggered from Jira
 
on:
  repository_dispatch:
    types: [jira-test-trigger]
 
jobs:
  run-tests:
    runs-on: ubuntu-latest
 
    steps:
      # 1️⃣ Validate trigger token
      - name: Validate Jira trigger
        run: |
          if [ "${{ github.event.client_payload.token }}" != "${{ secrets.JIRA_TRIGGER_TOKEN }}" ]; then
            echo "Invalid trigger"
            exit 1
          fi
 
      # 2️⃣ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4
 
      # 3️⃣ Setup Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
 
      # 4️⃣ Run Maven tests
      - name: Run Maven tests
        run: mvn test -Dtestng.groups=smoke -Dsurefire.skip=false
        id: test
 
      # 4b Upload Extent Report (Always runs, even if tests fail)
      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extent-report
          path: test-output/
 
      # 5️⃣ Install jq (if not available)
      - name: Install jq
        run: sudo apt-get install jq
 
      # 6️⃣ Extract stats from Surefire Report (XML)
      - name: Extract Test Stats from Surefire Report
        id: stats
        if: always() # Run even if tests fail so we get the stats
        run: |
          REPORT_PATH="target/surefire-reports/testng-results.xml"
          if [ -f "$REPORT_PATH" ]; then
            # Extract stats from the <testng-results> tag using grep and sed
            # Example tag: <testng-results ignored="2" total="17" passed="12" failed="1" skipped="0">
            
            # Extract raw counts
            PASSED_TESTS=$(grep -o 'passed="[0-9]*"' $REPORT_PATH | head -1 | cut -d'"' -f2)
            FAILED_TESTS=$(grep -o 'failed="[0-9]*"' $REPORT_PATH | head -1 | cut -d'"' -f2)
            SKIPPED_TESTS=$(grep -o 'skipped="[0-9]*"' $REPORT_PATH | head -1 | cut -d'"' -f2)
            IGNORED_TESTS=$(grep -o 'ignored="[0-9]*"' $REPORT_PATH | head -1 | cut -d'"' -f2)
            
            # Default to 0 if empty
            PASSED_TESTS=${PASSED_TESTS:-0}
            FAILED_TESTS=${FAILED_TESTS:-0}
            SKIPPED_TESTS=${SKIPPED_TESTS:-0}
            IGNORED_TESTS=${IGNORED_TESTS:-0}

            # Calculate Total to ensure numbers match for the user
            # (Raw 'total' attribute in XML often includes retries that aren't in the breakdown)
            TOTAL_TESTS=$((PASSED_TESTS + FAILED_TESTS + SKIPPED_TESTS + IGNORED_TESTS))
            
            # Extract duration-ms from the first <suite> tag
            DURATION_MS=$(grep -o 'duration-ms="[0-9]*"' $REPORT_PATH | head -1 | cut -d'"' -f2)
            if [ -n "$DURATION_MS" ]; then
              # Convert ms to seconds (integer division)
              TEST_DURATION=$((DURATION_MS / 1000))
            else
              TEST_DURATION="N/A"
            fi

            echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
            echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
            echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
            echo "skipped_tests=$SKIPPED_TESTS" >> $GITHUB_OUTPUT
            echo "ignored_tests=$IGNORED_TESTS" >> $GITHUB_OUTPUT
            echo "test_duration=$TEST_DURATION" >> $GITHUB_OUTPUT
          else
            echo "Surefire report not found at $REPORT_PATH"
            # Set defaults so the next step doesn't show empty
            echo "total_tests=0" >> $GITHUB_OUTPUT
            echo "passed_tests=0" >> $GITHUB_OUTPUT
            echo "failed_tests=0" >> $GITHUB_OUTPUT
            echo "skipped_tests=0" >> $GITHUB_OUTPUT
            echo "ignored_tests=0" >> $GITHUB_OUTPUT
            echo "test_duration=0" >> $GITHUB_OUTPUT
          fi
 
      # 7️⃣ Debug: Print Issue Key
      - name: Debug Issue Key
        if: always()
        run: |
          echo "Issue Key: ${{ github.event.client_payload.issueKey }}"

      # 8️⃣ Post comment to Jira (always runs)
      - name: Add comment to Jira issue
        if: always()  # Run this step regardless of test outcome (always)
        run: |
          STATUS="✅ Tests PASSED"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS="❌ Tests FAILED"
          fi
 
          # Retrieve test stats from previous step
          TOTAL_TESTS="${{ steps.stats.outputs.total_tests }}"
          PASSED_TESTS="${{ steps.stats.outputs.passed_tests }}"
          FAILED_TESTS="${{ steps.stats.outputs.failed_tests }}"
          SKIPPED_TESTS="${{ steps.stats.outputs.skipped_tests }}"
          IGNORED_TESTS="${{ steps.stats.outputs.ignored_tests }}"
          TEST_DURATION="${{ steps.stats.outputs.test_duration }}"
          # Add comment with statistics and file URL (report upload)
          COMMENT_BODY="Testing completed!\n\nTest Results:\nTotal Tests: $TOTAL_TESTS\nPassed: $PASSED_TESTS\nFailed: $FAILED_TESTS\nSkipped: $SKIPPED_TESTS\nDisabled: $IGNORED_TESTS\nTest Duration: $TEST_DURATION seconds\n\nTriggered from GitHub Actions"
 
          # Add the comment to the Jira issue
          curl -X POST \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${{ github.event.client_payload.issueKey }}/comment" \
            -d "{
                  \"body\": {
                    \"type\": \"doc\",
                    \"version\": 1,
                    \"content\": [
                      {
                        \"type\": \"paragraph\",
                        \"content\": [
                          {
                            \"type\": \"text\",
                            \"text\": \"$COMMENT_BODY\"
                          }
                        ]
                      }
                    ]
                  }
                }"
          # Upload Extent report to Jira as an attachment
          curl -X POST \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "X-Atlassian-Token: no-check" \
            -F "file=@test-output/extent-report.html" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${{ github.event.client_payload.issueKey }}/attachments"

      # 9️⃣ Push Report to External Repo
      - name: Push Report to External Repo
        if: always()
        env: 
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          if [ -z "$GH_PAT" ]; then
            echo "Error: GH_PAT secret is missing. Cannot push to external repo."
            exit 0
          fi

          echo "Cloning destination repository..."
          git clone https://x-access-token:$GH_PAT@github.com/na-v-ee-n/project-evelain.git dest_repo
          
          if [ ! -d "dest_repo" ]; then
             echo "Failed to clone repository. Check URL and Token."
             exit 1
          fi

          # Prepare target directory
          cd dest_repo
          mkdir -p input/post
          
          # Copy the report file
          if [ -f "../test-output/extent-report.html" ]; then
            cp "../test-output/extent-report.html" input/post/extent-report.html
            echo "Report copied successfully."
          else
            echo "Source report file not found!"
            ls -R ..
            exit 1
          fi

          # [NEW] Generate Metadata File for Evelain Auto-Repair
          # This allows Evelain to detect the Jira Issue Key automatically
          echo "{\"issueKey\": \"${{ github.event.client_payload.issueKey }}\"}" > input/post/report-metadata.json
          
          # Configure Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage changes (updated to include metadata)
          git add input/post/extent-report.html input/post/report-metadata.json
          
          # Commit and Push
          if git diff --staged --quiet; then
            echo "No changes in the report. Skipping push."
          else
            git commit -m "Update report & metadata from ${{ github.repository }} run ${{ github.run_id }}"
            git push
            echo "Report pushed to https://github.com/na-v-ee-n/project-evelain"
          fi